{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mensaje · {{ mensaje.subject|default:"(sin asunto)" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Fuente -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Iconos -->
  <link rel="stylesheet" href="{% static 'css/fontawesome.css' %}">
  <!-- Favicon (opcional) -->
  <link rel="icon" type="image/png" href="/static/img/favicon.png">

  <style>
    :root{
      --bg: #f3f4f6;
      --panel: #ffffff;
      --panel-border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --accent: #3b82f6;
      --accent-strong: #2563eb;
      --success: #10b981;
      --success-strong: #059669;
      --ghost: #d1d5db;
      --radius: 16px;
      --radius-sm: 12px;
      --shadow-1: 0 4px 12px rgba(0,0,0,.06);
      --shadow-2: 0 2px 8px rgba(0,0,0,.05);
    }
    *{ box-sizing:border-box }
    html,body{
      margin:0; padding:0; background:var(--bg); color:var(--text);
      font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    a{ color:var(--accent); text-decoration:none }
    a:hover{ text-decoration:underline }

    .wrap{ max-width:1040px; margin:0 auto; padding:24px }

    /* Breadcrumbs */
    .breadcrumbs{ display:flex; gap:8px; align-items:center; font-size:.95rem; color:var(--muted); margin-bottom:16px }
    .breadcrumbs .crumb{ font-weight:600 }
    .breadcrumbs .sep, .breadcrumbs .current{ color:#9ca3af }

    /* Header */
    .card{ background:var(--panel); border:1px solid var(--panel-border); border-radius:var(--radius); box-shadow:var(--shadow-1) }
    .msg-header{ padding:18px; margin-bottom:16px }
    .grid{ display:grid; grid-template-columns: 1fr auto; gap:12px }
    .subject{ margin:0; font-size:clamp(1.35rem, 2.5vw, 1.7rem); font-weight:800; display:flex; align-items:center; gap:10px }
    .subtitle{ margin-top:6px; color:var(--muted); font-weight:600 }
    .participants{ margin-top:12px; display:flex; align-items:center; gap:12px }
    .avatar{
      width:44px; height:44px; border-radius:50%; display:grid; place-items:center; font-weight:800; color:#fff;
      background:linear-gradient(135deg, #3b82f6, #9333ea); box-shadow:0 2px 6px rgba(0,0,0,.12); transition:transform .2s ease;
    }
    .avatar:hover{ transform:scale(1.03) }
    .who{ display:grid; gap:4px }
    .stamp{ min-width:200px; display:flex; flex-direction:column; align-items:flex-end; gap:4px }
    .stamp .label{ color:var(--muted); font-size:.9rem }
    .stamp .date{ font-weight:700; color:#111827 }

    .badge{ display:inline-block; padding:4px 10px; border-radius:9999px; font-size:.8rem; font-weight:800 }
    .badge-new{ background:#ef4444; color:#fff; animation:pulse 1.6s infinite }
    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(239,68,68,.45) }
      60%{ box-shadow:0 0 0 10px rgba(239,68,68,0) }
      100%{ box-shadow:0 0 0 0 rgba(239,68,68,0) }
    }

    /* Actions */
    .msg-actions{ background:var(--panel); border:1px solid var(--panel-border); border-radius:var(--radius-sm); box-shadow:var(--shadow-2);
      padding:12px; display:flex; flex-wrap:wrap; gap:10px; margin-bottom:16px }
    .inline{ display:inline }
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:9px 12px; border-radius:12px; font-weight:700;
      border:1px solid transparent; cursor:pointer; text-decoration:none; transition:all .2s ease;
    }
    .btn i{ font-size:1rem }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 2px 6px rgba(0,0,0,.08) }
    .btn:active{ transform:translateY(0); box-shadow:none }
    .btn-primary{ background:var(--accent); color:#fff }
    .btn-primary:hover{ background:var(--accent-strong) }
    .btn-secondary{ background:#f3f4f6; color:#374151 }
    .btn-secondary:hover{ background:#e5e7eb }
    .btn-success{ background:var(--success); color:#fff }
    .btn-success:hover{ background:var(--success-strong) }
    .btn-ghost{ background:transparent; color:#475569; border-color:var(--ghost) }
    .btn-ghost:hover{ background:#f9fafb }

    /* Body */
    .msg-body{ background:var(--panel); border:1px solid var(--panel-border); border-radius:var(--radius); box-shadow:var(--shadow-2);
      padding:16px; margin-bottom:16px }
    .prose{ color:#1f2937; line-height:1.7; max-width:70ch; margin:0 auto }
    .prose p{ margin:.6rem 0 }
    .prose h1,.prose h2,.prose h3{ margin:.6rem 0 .3rem }

    /* Attachments */
    .msg-attachments{ background:var(--panel); border:1px solid var(--panel-border); border-radius:var(--radius); box-shadow:var(--shadow-2);
      padding:14px; margin-bottom:16px }
    .section-title{ margin:0 0 10px; font-size:1rem; font-weight:800; color:#334155 }
    .files{ list-style:none; margin:0; padding:0; display:grid; gap:10px }
    .file a{
      display:flex; align-items:center; gap:10px; padding:8px; border-radius:12px; border:1px solid var(--panel-border);
      color:#1f2937; text-decoration:none; transition:background .2s ease, transform .2s ease;
    }
    .file a:hover{ background:#f3f4f6; transform:translateY(-1px) }
    .file .name{ font-weight:600 }
    .file .meta{ margin-left:auto; color:var(--muted); font-size:.85rem }

    /* Thread */
    .msg-thread{ background:var(--panel); border:1px solid var(--panel-border); border-radius:var(--radius); box-shadow:var(--shadow-2);
      padding:14px; margin-bottom:16px }
    .thread-list{ list-style:none; margin:0; padding:0; display:grid; gap:10px }
    .thread-item{ border:1px solid var(--panel-border); border-radius:12px; padding:10px; background:#f8fafc; border-left:4px solid #d1d5db }
    .thread-item.me{ background:#eef2ff; border-color:#c7d2fe; border-left-color:var(--accent) }
    .ti-head{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; font-weight:700; color:#334155 }
    .tstamp{ color:var(--muted); font-weight:600 }
    .ti-body{ margin-top:6px; color:#1f2937 }

    /* Reply */
    .msg-reply{ background:var(--panel); border:1px solid var(--panel-border); border-radius:var(--radius); box-shadow:var(--shadow-2); padding:14px }
    .reply-form{ display:grid; gap:10px }
    .form-row{ display:grid; gap:6px }
    .input{
      width:100%; border:1px solid #d1d5db; border-radius:12px; padding:10px; font-size:1rem; color:#111827;
      background:#f9fafb; transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .input:focus{ outline:none; border-color:var(--accent); background:#fff; box-shadow:0 0 0 3px rgba(59,130,246,.3) }
    .form-actions{ display:flex; gap:10px }

    /* A11y */
    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0);
      white-space:nowrap; border:0;
    }

    /* Responsive */
    @media (max-width: 720px){
      .wrap{ padding:16px }
      .grid{ grid-template-columns:1fr }
      .stamp{ align-items:flex-start; min-width:0 }
      .subject{ font-size:1.35rem }
      .avatar{ width:40px; height:40px }
    }

    /* Animación al desaparecer */
    .fade-out{ animation: fadeOut .2s ease forwards }
    @keyframes fadeOut{ to{ opacity:0; transform: translateY(6px) } }
  </style>
</head>
<body>
  <div class="wrap" id="msg-detail">
    <nav class="breadcrumbs" aria-label="Ruta de navegación">
      <a href="{% url 'dashboard:inbox' %}" class="crumb">Mensajes</a>
      <span class="sep" aria-hidden="true">/</span>
      <span class="current">Detalle</span>
    </nav>

    <header class="card msg-header" role="region" aria-label="Cabecera del mensaje">
      <div class="grid">
        <div>
          <h1 class="subject">
            {{ mensaje.subject|default:"(sin asunto)" }}
            {% if not mensaje.is_read %}
              <span class="badge badge-new" title="No leído" aria-label="Mensaje no leído">Nuevo</span>
            {% endif %}
          </h1>
          <p class="subtitle">Chat directo · Conversación privada</p>
          <div class="participants">
            <div class="avatar" aria-hidden="true">{{ mensaje.sender.username|slice:":1"|upper }}</div>
            <div class="who">
              <span class="line"><strong>De:</strong> {{ mensaje.sender.get_full_name|default:mensaje.sender.username }}</span>
              <span class="line"><strong>Para:</strong> {{ mensaje.receiver.get_full_name|default:mensaje.receiver.username }}</span>
            </div>
          </div>
        </div>
        <div class="stamp">
          <span class="label">Enviado</span>
          <time datetime="{{ mensaje.created_at|date:'c' }}" class="date">{{ mensaje.created_at|date:"l d \\d\\e M Y · H:i" }}</time>
        </div>
      </div>
    </header>

    <div class="msg-actions" role="group" aria-label="Acciones del mensaje">
      <form method="post" action="{% url 'dashboard:toggle_read' mensaje.id %}" class="inline mark-read-form">
        {% csrf_token %}
        {% if mensaje.is_read %}
          <button type="submit" class="btn btn-secondary" aria-pressed="true">
            <i class="fa-solid fa-envelope-open"></i><span>Marcar como no leído</span>
          </button>
        {% else %}
          <button type="submit" class="btn btn-primary" aria-pressed="false">
            <i class="fa-solid fa-envelope"></i><span>Marcar como leído</span>
          </button>
        {% endif %}
      </form>

      <a href="{% url 'dashboard:chat' mensaje.sender.id %}" class="btn btn-ghost">
        <i class="fa-solid fa-comments"></i><span>Abrir chat</span>
      </a>

      <a href="{% url 'dashboard:inbox' %}" class="btn btn-ghost">
        <i class="fa-solid fa-inbox"></i><span>Volver a bandeja</span>
      </a>
    </div>

    <article class="msg-body" role="article" aria-label="Contenido del mensaje">
      {% if mensaje.content_html %}
        <div class="prose">{{ mensaje.content_html|safe }}</div>
      {% else %}
        <div class="prose"><p>{{ mensaje.content|linebreaksbr }}</p></div>
      {% endif %}
    </article>

    {% with files=mensaje.attachments.all %}
      {% if files %}
      <section class="msg-attachments" role="region" aria-label="Adjuntos">
        <h2 class="section-title">Adjuntos</h2>
        <ul class="files">
          {% for f in files %}
            <li class="file">
              <a href="{{ f.file.url }}" target="_blank" rel="noopener">
                <i class="fa-solid {% if f.mime|default:''|startswith:'application/pdf' %}fa-file-pdf{% elif f.mime|default:''|startswith:'image/' %}fa-file-image{% else %}fa-paperclip{% endif %}"></i>
                <span class="name">{{ f.name|default:f.file.name }}</span>
                <span class="meta">
                  {{ f.size_human|default:"" }}{% if f.size_human and f.mime %} · {% endif %}{{ f.mime|default:"" }}
                </span>
              </a>
            </li>
          {% endfor %}
        </ul>
      </section>
      {% endif %}
    {% endwith %}

    {% if thread %}
    <section class="msg-thread" role="region" aria-label="Hilo del mensaje">
      <h2 class="section-title">Hilo</h2>
      <ul class="thread-list">
        {% for item in thread %}
        <li class="thread-item {% if item.sender_id == request.user.id %}me{% endif %}">
          <div class="ti-head">
            <span class="who">{{ item.sender.get_full_name|default:item.sender.username }}</span>
            <time class="tstamp" datetime="{{ item.created_at|date:'c' }}">{{ item.created_at|date:"d M Y · H:i" }}</time>
          </div>
          <div class="ti-body">{{ item.content|linebreaksbr }}</div>
        </li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}

    <section class="msg-reply" role="form" aria-label="Respuesta rápida">
      <h2 class="section-title">Responder</h2>
      <form method="post" action="{% url 'dashboard:reply' mensaje.id %}" class="reply-form">
        {% csrf_token %}
        <div class="form-row">
          <label for="reply-content" class="sr-only">Contenido de la respuesta</label>
          <textarea id="reply-content" name="content" rows="5" class="input" placeholder="Escribe tu respuesta..." required></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-success">
            <i class="fa-solid fa-paper-plane"></i><span>Enviar respuesta</span>
          </button>
          <a href="{% url 'dashboard:inbox' %}" class="btn btn-ghost">Cancelar</a>
        </div>
      </form>
    </section>
  </div>

  <script>
    (function(){
      // Interceptar "marcar leído/no leído" para eliminar el detalle al instante
      const form = document.querySelector(".mark-read-form");
      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const token = form.querySelector("input[name='csrfmiddlewaretoken']")?.value;
          const btn = form.querySelector("button[type='submit']");
          if (btn) btn.disabled = true;

          try {
            const res = await fetch(form.action, {
              method: "POST",
              headers: token ? { "X-CSRFToken": token } : {}
            });
            if (res.status === 204) {
              const wrapper = document.getElementById("msg-detail");
              if (wrapper) {
                wrapper.classList.add("fade-out");
                setTimeout(() => {
                  wrapper.remove();
                  // Redirige a la bandeja (flujo natural tras eliminar el detalle)
                  window.location.href = "{% url 'dashboard:inbox' %}";
                }, 200);
              }
              // Opcional: actualiza badges si existen en DOM global
              const dashBadge = document.getElementById("dash-unread-count");
              if (dashBadge && dashBadge.textContent) {
                const n = parseInt(dashBadge.textContent, 10);
                if (!isNaN(n) && n > 0) dashBadge.textContent = String(n - 1);
              }
              const notifCount = document.getElementById("notif-count");
              if (notifCount && notifCount.textContent) {
                const m = parseInt(notifCount.textContent, 10);
                if (!isNaN(m) && m > 0) notifCount.textContent = String(m - 1);
              }
            } else {
              if (btn) btn.disabled = false;
            }
          } catch (err) {
            if (btn) btn.disabled = false;
          }
        });
      }

      // Interceptar respuesta rápida para insertar en el hilo sin recarga
      const replyForm = document.querySelector(".reply-form");
      if (replyForm) {
        replyForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const token = replyForm.querySelector("input[name='csrfmiddlewaretoken']")?.value;
          const textarea = document.getElementById("reply-content");
          const content = (textarea?.value || "").trim();
          if (!content) return;

          const btn = replyForm.querySelector("button[type='submit']");
          if (btn) btn.disabled = true;

          try {
            const res = await fetch(replyForm.action, {
              method: "POST",
              headers: {
                ...(token ? { "X-CSRFToken": token } : {}),
                "Content-Type": "application/x-www-form-urlencoded"
              },
              body: new URLSearchParams({ content })
            });

            if (res.redirected || res.ok) {
              const list = document.querySelector(".thread-list");
              if (list) {
                const li = document.createElement("li");
                li.className = "thread-item me";
                const now = new Date();
                const fecha = now.toLocaleDateString("es-ES", { day: "2-digit", month: "short", year: "numeric" });
                const hora = now.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" });
                li.innerHTML = `
                  <div class="ti-head">
                    <span class="who">{{ request.user.get_full_name|default:request.user.username }}</span>
                    <time class="tstamp">${fecha} · ${hora}</time>
                  </div>
                  <div class="ti-body"></div>
                `;
                li.querySelector(".ti-body").textContent = content;
                list.appendChild(li);
              }
              document.querySelector(".badge-new")?.remove();
              if (textarea) textarea.value = "";
            }
          } catch (err) {
            // opcional: mostrar feedback de error
          } finally {
            if (btn) btn.disabled = false;
          }
        });
      }
    })();
  </script>
</body>
</html>
